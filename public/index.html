<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTubeæ•°æ®æå–å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FF0000, #FF4500);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .api-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #FF0000;
        }

        .api-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #FF0000;
        }

        .api-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #FF0000;
            color: white;
        }

        .btn-primary:hover {
            background: #cc0000;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .search-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #FF0000;
        }

        .search-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
        }

        .option-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .option-group select,
        .option-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-search {
            background: linear-gradient(135deg, #FF0000, #FF4500);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255,0,0,0.3);
        }

        .btn-search:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255,0,0,0.4);
        }

        .btn-search:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF0000, #FF4500);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #333;
        }

        .results-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .results-stats {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .channel-link {
            color: #FF0000;
            text-decoration: none;
            font-weight: 500;
        }

        .channel-link:hover {
            text-decoration: underline;
        }

        .download-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .btn-download {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-download:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-weight: 500;
        }

        .api-status.valid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.invalid {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            .api-input-group {
                flex-direction: column;
            }

            .search-options {
                grid-template-columns: 1fr;
            }

            .results-table {
                font-size: 14px;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ YouTubeæ•°æ®æå–å·¥å…·</h1>
            <p>æœç´¢YouTubeè§†é¢‘å¹¶æå–é¢‘é“ä¿¡æ¯ï¼Œç”ŸæˆExcelæŠ¥è¡¨</p>
        </div>

        <div class="main-content">
            <!-- APIé…ç½®åŒºåŸŸ -->
            <div class="api-section">
                <h3>ğŸ”‘ YouTube APIé…ç½®</h3>
                <div class="api-input-group">
                    <input type="text" id="apiKey" class="api-input" placeholder="è¯·è¾“å…¥YouTube Data API Key" value="">
                    <div class="api-buttons">
                        <button class="btn btn-primary" onclick="saveApiKey()">ä¿å­˜API</button>
                        <button class="btn btn-secondary" onclick="loadApiKeys()">å¿«é€Ÿåˆ‡æ¢</button>
                    </div>
                </div>
                <div id="apiStatus" class="api-status" style="display: none;"></div>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    ğŸ’¡ è·å–APIå¯†é’¥ï¼šè®¿é—® <a href="https://console.developers.google.com/" target="_blank">Google Cloud Console</a> 
                    â†’ å¯ç”¨YouTube Data API v3 â†’ åˆ›å»ºå‡­æ®
                </p>
            </div>

            <!-- æœç´¢åŒºåŸŸ -->
            <div class="search-section">
                <h3 style="margin-bottom: 20px; color: #333;">ğŸ” æœç´¢è®¾ç½®</h3>
                <input type="text" id="searchKeyword" class="search-input" placeholder="è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼‰">
                
                <div class="search-options">
                    <div class="option-group">
                        <label>æœç´¢ç±»å‹</label>
                        <select id="searchType">
                            <option value="video">è§†é¢‘</option>
                            <option value="channel">é¢‘é“</option>
                            <option value="playlist">æ’­æ”¾åˆ—è¡¨</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label>ç»“æœæ•°é‡</label>
                        <select id="maxResults">
                            <option value="10">10ä¸ª</option>
                            <option value="25">25ä¸ª</option>
                            <option value="50">50ä¸ª</option>
                            <option value="100">100ä¸ª</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label>æ’åºæ–¹å¼</label>
                        <select id="sortOrder">
                            <option value="relevance">ç›¸å…³æ€§</option>
                            <option value="date">å‘å¸ƒæ—¶é—´</option>
                            <option value="rating">è¯„åˆ†</option>
                            <option value="viewCount">è§‚çœ‹æ¬¡æ•°</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label>å‘å¸ƒæ—¶é—´</label>
                        <select id="publishedAfter">
                            <option value="">å…¨éƒ¨æ—¶é—´</option>
                            <option value="today">ä»Šå¤©</option>
                            <option value="week">æœ¬å‘¨</option>
                            <option value="month">æœ¬æœˆ</option>
                            <option value="year">ä»Šå¹´</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="btn-search" onclick="startSearch()">
                        <span id="searchButtonText">å¼€å§‹æœç´¢</span>
                    </button>
                </div>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="progressSection" class="progress-section">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ“Š æå–è¿›åº¦</h3>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">å‡†å¤‡å¼€å§‹...</div>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯åŒºåŸŸ -->
            <div id="errorMessage" class="error-message"></div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="resultsSection" class="results-section">
                <h3 style="margin-bottom: 20px; color: #333;">ğŸ“‹ æå–ç»“æœ</h3>
                <div id="resultsStats" class="results-stats"></div>
                
                <div style="overflow-x: auto;">
                    <table id="resultsTable" class="results-table">
                        <thead>
                            <tr>
                                <th>é¢‘é“åç§°</th>
                                <th>é¢‘é“ID</th>
                                <th>è®¢é˜…è€…æ•°</th>
                                <th>è§†é¢‘æ•°é‡</th>
                                <th>é¢‘é“é“¾æ¥</th>
                                <th>æè¿°</th>
                                <th>å›½å®¶</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="download-section">
                    <button class="btn-download" onclick="downloadExcel()">
                        ğŸ“¥ ä¸‹è½½ExcelæŠ¥è¡¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let searchResults = [];
        let apiKeys = JSON.parse(localStorage.getItem('youtubeApiKeys') || '[]');

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedApiKey();
        });

        // ä¿å­˜APIå¯†é’¥
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showError('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            // éªŒè¯APIå¯†é’¥æ ¼å¼
            if (!/^AIza[0-9A-Za-z-_]{35}$/.test(apiKey)) {
                showError('APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®');
                return;
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('youtubeApiKey', apiKey);
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            if (!apiKeys.includes(apiKey)) {
                apiKeys.unshift(apiKey);
                if (apiKeys.length > 5) apiKeys.pop(); // åªä¿ç•™æœ€è¿‘5ä¸ª
                localStorage.setItem('youtubeApiKeys', JSON.stringify(apiKeys));
            }

            showApiStatus('APIå¯†é’¥å·²ä¿å­˜', 'valid');
            validateApiKey(apiKey);
        }

        // åŠ è½½ä¿å­˜çš„APIå¯†é’¥
        function loadSavedApiKey() {
            const savedKey = localStorage.getItem('youtubeApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                validateApiKey(savedKey);
            }
        }

        // å¿«é€Ÿåˆ‡æ¢APIå¯†é’¥
        function loadApiKeys() {
            if (apiKeys.length === 0) {
                showError('æ²¡æœ‰ä¿å­˜çš„APIå¯†é’¥');
                return;
            }

            const select = document.createElement('select');
            select.style.cssText = 'width: 100%; padding: 10px; margin: 10px 0;';
            
            apiKeys.forEach((key, index) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `API ${index + 1}: ${key.substr(0, 8)}...${key.substr(-4)}`;
                select.appendChild(option);
            });

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 20px; border-radius: 10px; 
                max-width: 400px; width: 90%;
            `;

            content.innerHTML = `
                <h3 style="margin-bottom: 15px;">é€‰æ‹©APIå¯†é’¥</h3>
                <div style="margin-bottom: 15px;"></div>
                <div style="text-align: right;">
                    <button onclick="this.closest('.modal').remove()" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                    <button onclick="selectApiKey()" style="padding: 8px 16px; background: #FF0000; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
                </div>
            `;

            content.children[1].appendChild(select);
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);

            window.selectApiKey = function() {
                document.getElementById('apiKey').value = select.value;
                validateApiKey(select.value);
                modal.remove();
            };
        }

        // éªŒè¯APIå¯†é’¥
        async function validateApiKey(apiKey) {
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&maxResults=1&key=${apiKey}`);
                if (response.ok) {
                    showApiStatus('APIå¯†é’¥æœ‰æ•ˆ âœ“', 'valid');
                } else {
                    showApiStatus('APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ âœ—', 'invalid');
                }
            } catch (error) {
                showApiStatus('æ— æ³•éªŒè¯APIå¯†é’¥', 'invalid');
            }
        }

        // æ˜¾ç¤ºAPIçŠ¶æ€
        function showApiStatus(message, type) {
            const status = document.getElementById('apiStatus');
            status.textContent = message;
            status.className = `api-status ${type}`;
            status.style.display = 'block';
        }

        // å¼€å§‹æœç´¢
        async function startSearch() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const keyword = document.getElementById('searchKeyword').value.trim();

            if (!apiKey) {
                showError('è¯·å…ˆé…ç½®YouTube APIå¯†é’¥');
                return;
            }

            if (!keyword) {
                showError('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            // é‡ç½®ç•Œé¢
            hideError();
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            
            const searchButton = document.querySelector('.btn-search');
            const buttonText = document.getElementById('searchButtonText');
            searchButton.disabled = true;
            buttonText.innerHTML = '<span class="loading"></span>æœç´¢ä¸­...';

            try {
                // ç¬¬ä¸€æ­¥ï¼šæœç´¢è§†é¢‘
                updateProgress(10, 'æœç´¢YouTubeè§†é¢‘...');
                const searchResults = await searchYouTubeVideos(apiKey, keyword);
                
                if (searchResults.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è§†é¢‘');
                }

                // ç¬¬äºŒæ­¥ï¼šè·å–é¢‘é“ä¿¡æ¯
                updateProgress(30, `æ‰¾åˆ° ${searchResults.length} ä¸ªè§†é¢‘ï¼Œæ­£åœ¨è·å–é¢‘é“ä¿¡æ¯...`);
                const channelIds = [...new Set(searchResults.map(video => video.channelId))];
                const channelsData = await getChannelsData(apiKey, channelIds);

                // ç¬¬ä¸‰æ­¥ï¼šå¤„ç†æ•°æ®
                updateProgress(80, 'å¤„ç†æ•°æ®ä¸­...');
                processResults(channelsData);

                // å®Œæˆ
                updateProgress(100, 'æå–å®Œæˆï¼');
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                }, 1000);

            } catch (error) {
                showError(`æœç´¢å¤±è´¥: ${error.message}`);
                document.getElementById('progressSection').style.display = 'none';
            } finally {
                searchButton.disabled = false;
                buttonText.textContent = 'å¼€å§‹æœç´¢';
            }
        }

        // æœç´¢YouTubeè§†é¢‘
        async function searchYouTubeVideos(apiKey, keyword) {
            const maxResults = document.getElementById('maxResults').value;
            const order = document.getElementById('sortOrder').value;
            const publishedAfter = getPublishedAfterDate();

            let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(keyword)}&type=video&maxResults=${maxResults}&order=${order}&key=${apiKey}`;
            
            if (publishedAfter) {
                url += `&publishedAfter=${publishedAfter}`;
            }

            const response = await fetch(url);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'æœç´¢è¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            return data.items.map(item => ({
                videoId: item.id.videoId,
                title: item.snippet.title,
                channelId: item.snippet.channelId,
                channelTitle: item.snippet.channelTitle,
                publishedAt: item.snippet.publishedAt
            }));
        }

        // è·å–é¢‘é“æ•°æ®
        async function getChannelsData(apiKey, channelIds) {
            const channelsData = [];
            const batchSize = 50; // YouTube API æ¯æ¬¡æœ€å¤šæŸ¥è¯¢50ä¸ªé¢‘é“

            for (let i = 0; i < channelIds.length; i += batchSize) {
                const batch = channelIds.slice(i, i + batchSize);
                const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=${batch.join(',')}&key=${apiKey}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('è·å–é¢‘é“ä¿¡æ¯å¤±è´¥:', await response.text());
                    continue;
                }

                const data = await response.json();
                channelsData.push(...data.items);

                // æ›´æ–°è¿›åº¦
                const progress = 30 + (i / channelIds.length) * 50;
                updateProgress(progress, `è·å–é¢‘é“ä¿¡æ¯ ${i + batch.length}/${channelIds.length}`);
            }

            return channelsData;
        }

        // å¤„ç†ç»“æœ
        function processResults(channelsData) {
            searchResults = channelsData.map(channel => {
                const snippet = channel.snippet;
                const statistics = channel.statistics;
                const branding = channel.brandingSettings;

                return {
                    channelName: snippet.title,
                    channelId: channel.id,
                    subscriberCount: statistics.subscriberCount || 'æœªå…¬å¼€',
                    videoCount: statistics.videoCount || '0',
                    channelUrl: `https://www.youtube.com/channel/${channel.id}`,
                    description: snippet.description || '',
                    country: snippet.country || 'æœªçŸ¥',
                    createdAt: snippet.publishedAt,
                    thumbnailUrl: snippet.thumbnails?.default?.url || '',
                    viewCount: statistics.viewCount || '0',
                    email: branding?.channel?.unsubscribedTrailer || '', // è¿™é‡Œéœ€è¦æ›´å¤æ‚çš„æå–é€»è¾‘
                    customUrl: snippet.customUrl || ''
                };
            });

            displayResults();
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults() {
            const statsDiv = document.getElementById('resultsStats');
            const tbody = document.getElementById('resultsTableBody');

            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            statsDiv.innerHTML = `
                <strong>æå–å®Œæˆï¼</strong> 
                å…±æ‰¾åˆ° <strong>${searchResults.length}</strong> ä¸ªç‹¬ç‰¹é¢‘é“
            `;

            // æ¸…ç©ºè¡¨æ ¼
            tbody.innerHTML = '';

            // å¡«å……è¡¨æ ¼æ•°æ®
            searchResults.forEach((channel, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${channel.channelName}</strong></td>
                    <td><code>${channel.channelId}</code></td>
                    <td>${formatNumber(channel.subscriberCount)}</td>
                    <td>${formatNumber(channel.videoCount)}</td>
                    <td><a href="${channel.channelUrl}" target="_blank" class="channel-link">è®¿é—®é¢‘é“</a></td>
                    <td>${channel.description.length > 100 ? channel.description.substring(0, 100) + '...' : channel.description}</td>
                    <td>${channel.country}</td>
                    <td>${formatDate(channel.createdAt)}</td>
                `;
            });
        }

        // ä¸‹è½½Excel
        function downloadExcel() {
            if (searchResults.length === 0) {
                showError('æ²¡æœ‰æ•°æ®å¯ä»¥ä¸‹è½½');
                return;
            }

            // å‡†å¤‡Excelæ•°æ®
            const wsData = [
                ['é¢‘é“åç§°', 'é¢‘é“ID', 'é¢‘é“é“¾æ¥', 'è®¢é˜…è€…æ•°', 'è§†é¢‘æ•°é‡', 'æ€»è§‚çœ‹æ¬¡æ•°', 'å›½å®¶', 'åˆ›å»ºæ—¶é—´', 'æè¿°', 'è‡ªå®šä¹‰URL']
            ];

            searchResults.forEach(channel => {
                wsData.push([
                    channel.channelName,
                    channel.channelId,
                    channel.channelUrl,
                    channel.subscriberCount,
                    channel.videoCount,
                    channel.viewCount,
                    channel.country,
                    formatDate(channel.createdAt),
                    channel.description,
                    channel.customUrl
                ]);
            });

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                {wch: 20}, // é¢‘é“åç§°
                {wch: 25}, // é¢‘é“ID
                {wch: 40}, // é¢‘é“é“¾æ¥
                {wch: 15}, // è®¢é˜…è€…æ•°
                {wch: 12}, // è§†é¢‘æ•°é‡
                {wch: 15}, // æ€»è§‚çœ‹æ¬¡æ•°
                {wch: 10}, // å›½å®¶
                {wch: 12}, // åˆ›å»ºæ—¶é—´
                {wch: 50}, // æè¿°
                {wch: 30}  // è‡ªå®šä¹‰URL
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'YouTubeé¢‘é“æ•°æ®');

            // ä¸‹è½½æ–‡ä»¶
            const keyword = document.getElementById('searchKeyword').value;
            const filename = `YouTubeé¢‘é“æ•°æ®_${keyword}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // å·¥å…·å‡½æ•°
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function formatNumber(num) {
            if (num === 'æœªå…¬å¼€' || !num) return num;
            return parseInt(num).toLocaleString();
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function getPublishedAfterDate() {
            const option = document.getElementById('publishedAfter').value;
            const now = new Date();
            
            switch(option) {
                case 'today':
                    return new Date(now.setHours(0,0,0,0)).toISOString();
                case 'week':
                    return new Date(now.setDate(now.getDate() - 7)).toISOString();
                case 'month':
                    return new Date(now.setMonth(now.getMonth() - 1)).toISOString();
                case 'year':
                    return new Date(now.setFullYear(now.getFullYear() - 1)).toISOString();
                default:
                    return '';
            }
        }
    </script>
</body>
</html>